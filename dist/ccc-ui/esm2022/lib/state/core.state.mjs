import { __decorate } from "tslib";
import { Injectable, inject } from "@angular/core";
import { Action, Selector, State } from "@ngxs/store";
import { patch } from "@ngxs/store/operators";
import { cloneDeep } from "lodash-es";
import { tap } from "rxjs";
import { Domain } from "../models/permission-domain";
import { AuthService } from "../service/auth.service";
import { ErrorService } from "../service/error.service";
import { ApiInterceptorAction, AppAction, AuthenticationGuardAction, HeaderAction, LoginAction } from "./core.actions";
import * as i0 from "@angular/core";
export const initState = {
    loading: [],
    sidenavOpened: true,
    currentSidenavIdentifier: "",
    auth: {
        authenticated: false,
        redirectUrl: "",
        sessionInfo: null,
    },
};
let CoreState = class CoreState {
    authService = inject(AuthService);
    errors = inject(ErrorService);
    static sidenavOpened(state) {
        return state?.sidenavOpened;
    }
    static permissions(state) {
        return state?.auth.sessionInfo?.permissions[Domain.Global];
    }
    static hasPermission(state) {
        return (permissions) => {
            if (state?.auth.sessionInfo?.permissions[Domain.Global]) {
                return state.auth.sessionInfo.permissions[Domain.Global].some((p) => permissions.includes(p));
            }
            return false;
        };
    }
    static isAuthenticated(state) {
        return state?.auth.authenticated;
    }
    static redirectUrl(state) {
        return state?.auth.redirectUrl;
    }
    static isLoading(state) {
        return state.loading.length > 0;
    }
    static currentSidenavIdentifier(state) {
        return state.currentSidenavIdentifier;
    }
    setNavIdentifier(ctx, action) {
        ctx.setState(patch({
            currentSidenavIdentifier: action.identifier,
        }));
    }
    publishError(ctx, action) {
        this.errors.addGlobalError(action.message);
    }
    checkUserSession(ctx) {
        return this.authService.checkUserSession().pipe(tap((result) => ctx.setState(patch({
            auth: patch({
                authenticated: !!result?.authenticated,
                sessionInfo: result,
            }),
        }))));
    }
    logout(ctx) {
        const localStateCopy = cloneDeep(initState);
        localStateCopy.auth.redirectUrl = ctx.getState().auth.redirectUrl;
        return this.authService.logout().pipe(tap(() => {
            ctx.setState(localStateCopy);
        }));
    }
    setRedirectUrl(ctx, action) {
        ctx.setState(patch({
            auth: patch({
                redirectUrl: action.redirectUrl,
            }),
        }));
        return ctx.getState();
    }
    beginActivity(ctx, action) {
        const state = ctx.getState();
        ctx.patchState({
            loading: [action.process, ...state.loading],
        });
        return ctx.getState();
    }
    endActivity(ctx, action) {
        const loading = ctx.getState().loading;
        // There can be multiple activities running with the same process signature
        const index = loading.findIndex((activity) => activity === action.process);
        if (index !== -1) {
            const newLoading = [...loading.slice(0, index), ...loading.slice(index + 1)];
            ctx.patchState({
                loading: newLoading,
            });
            return ctx.getState();
        }
        return null;
    }
    toggleSidenav(ctx) {
        ctx.setState(patch({
            sidenavOpened: !ctx.getState().sidenavOpened,
        }));
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.7", ngImport: i0, type: CoreState, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
    static ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.7", ngImport: i0, type: CoreState });
};
__decorate([
    Action([AppAction.SetNavIdentifier])
], CoreState.prototype, "setNavIdentifier", null);
__decorate([
    Action([ApiInterceptorAction.PublishError, LoginAction.PublishError])
], CoreState.prototype, "publishError", null);
__decorate([
    Action([AppAction.CheckUserSession, AuthenticationGuardAction.CheckUserSession])
], CoreState.prototype, "checkUserSession", null);
__decorate([
    Action([LoginAction.Logout])
], CoreState.prototype, "logout", null);
__decorate([
    Action([
        AppAction.SetRedirectUrl,
        LoginAction.SetRedirectUrl,
        AuthenticationGuardAction.SetRedirectUrl,
        ApiInterceptorAction.SetRedirectUrl,
    ])
], CoreState.prototype, "setRedirectUrl", null);
__decorate([
    Action([ApiInterceptorAction.BeginActivity])
], CoreState.prototype, "beginActivity", null);
__decorate([
    Action([ApiInterceptorAction.EndActivity])
], CoreState.prototype, "endActivity", null);
__decorate([
    Action([HeaderAction.ToggleSidenav])
], CoreState.prototype, "toggleSidenav", null);
__decorate([
    Selector()
], CoreState, "sidenavOpened", null);
__decorate([
    Selector()
], CoreState, "permissions", null);
__decorate([
    Selector()
], CoreState, "hasPermission", null);
__decorate([
    Selector()
], CoreState, "isAuthenticated", null);
__decorate([
    Selector()
], CoreState, "redirectUrl", null);
__decorate([
    Selector()
], CoreState, "isLoading", null);
__decorate([
    Selector()
], CoreState, "currentSidenavIdentifier", null);
CoreState = __decorate([
    State({
        name: "coreState",
        defaults: initState,
    })
], CoreState);
export { CoreState };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.7", ngImport: i0, type: CoreState, decorators: [{
            type: Injectable
        }], propDecorators: { setNavIdentifier: [], publishError: [], checkUserSession: [], logout: [], setRedirectUrl: [], beginActivity: [], endActivity: [], toggleSidenav: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS5zdGF0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NjYy1saWIvc3JjL2xpYi9zdGF0ZS9jb3JlLnN0YXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQWdCLE1BQU0sYUFBYSxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBYyxHQUFHLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFdkMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRXJELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDeEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLFNBQVMsRUFBRSx5QkFBeUIsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7O0FBYXZILE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBbUI7SUFDdkMsT0FBTyxFQUFFLEVBQUU7SUFDWCxhQUFhLEVBQUUsSUFBSTtJQUNuQix3QkFBd0IsRUFBRSxFQUFFO0lBQzVCLElBQUksRUFBRTtRQUNKLGFBQWEsRUFBRSxLQUFLO1FBQ3BCLFdBQVcsRUFBRSxFQUFFO1FBQ2YsV0FBVyxFQUFFLElBQUk7S0FDbEI7Q0FDRixDQUFDO0FBT0ssSUFBTSxTQUFTLEdBQWYsTUFBTSxTQUFTO0lBQ1osV0FBVyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNsQyxNQUFNLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxD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LEVBQUU7K0NBR1Y7QUEzQ1UsU0FBUztJQUxyQixLQUFLLENBQWlCO1FBQ3JCLElBQUksRUFBRSxXQUFXO1FBQ2pCLFFBQVEsRUFBRSxTQUFTO0tBQ3BCLENBQUM7R0FFVyxTQUFTLENBdUlyQjs7MkZBdklZLFNBQVM7a0JBRHJCLFVBQVU7OEJBK0NULGdCQUFnQixNQVNoQixZQUFZLE1BS1osZ0JBQWdCLE1BZ0JoQixNQUFNLE1BZ0JOLGNBQWMsTUFZZCxhQUFhLE1BU2IsV0FBVyxNQWVYLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBpbmplY3QgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgQWN0aW9uLCBTZWxlY3RvciwgU3RhdGUsIFN0YXRlQ29udGV4dCB9IGZyb20gXCJAbmd4cy9zdG9yZVwiO1xuaW1wb3J0IHsgcGF0Y2ggfSBmcm9tIFwiQG5neHMvc3RvcmUvb3BlcmF0b3JzXCI7XG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tIFwibG9kYXNoLWVzXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0YXAgfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgRXJyb3JNZXNzYWdlIH0gZnJvbSBcIi4uL21vZGVscy9lcnJvci1tZXNzYWdlXCI7XG5pbXBvcnQgeyBEb21haW4gfSBmcm9tIFwiLi4vbW9kZWxzL3Blcm1pc3Npb24tZG9tYWluXCI7XG5pbXBvcnQgeyBTZXNzaW9uSW5mbyB9IGZyb20gXCIuLi9tb2RlbHMvc2Vzc2lvbi1pbmZvXCI7XG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlL2F1dGguc2VydmljZVwiO1xuaW1wb3J0IHsgRXJyb3JTZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2UvZXJyb3Iuc2VydmljZVwiO1xuaW1wb3J0IHsgQXBpSW50ZXJjZXB0b3JBY3Rpb24sIEFwcEFjdGlvbiwgQXV0aGVudGljYXRpb25HdWFyZEFjdGlvbiwgSGVhZGVyQWN0aW9uLCBMb2dpbkFjdGlvbiB9IGZyb20gXCIuL2NvcmUuYWN0aW9uc1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvcmVTdGF0ZU1vZGVsIHtcbiAgbG9hZGluZzogc3RyaW5nW107XG4gIHNpZGVuYXZPcGVuZWQ6IGJvb2xlYW47XG4gIGN1cnJlbnRTaWRlbmF2SWRlbnRpZmllcjogc3RyaW5nO1xuICBhdXRoOiB7XG4gICAgYXV0aGVudGljYXRlZDogYm9vbGVhbjtcbiAgICByZWRpcmVjdFVybDogc3RyaW5nO1xuICAgIHNlc3Npb25JbmZvOiBTZXNzaW9uSW5mbyB8IG51bGw7XG4gIH07XG59XG5cbmV4cG9ydCBjb25zdCBpbml0U3RhdGU6IENvcmVTdGF0ZU1vZGVsID0ge1xuICBsb2FkaW5nOiBbXSxcbiAgc2lkZW5hdk9wZW5lZDogdHJ1ZSxcbiAgY3VycmVudFNpZGVuYXZJZGVudGlmaWVyOiBcIlwiLFxuICBhdXRoOiB7XG4gICAgYXV0aGVudGljYXRlZDogZmFsc2UsXG4gICAgcmVkaXJlY3RVcmw6IFwiXCIsXG4gICAgc2Vzc2lvbkluZm86IG51bGwsXG4gIH0sXG59O1xuXG5AU3RhdGU8Q29yZVN0YXRlTW9kZWw+KHtcbiAgbmFtZTogXCJjb3JlU3RhdGVcIixcbiAgZGVmYXVsdHM6IGluaXRTdGF0ZSxcbn0pXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ29yZVN0YXRlIHtcbiAgcHJpdmF0ZSBhdXRoU2VydmljZSA9IGluamVjdChBdXRoU2VydmljZSk7XG4gIHByaXZhdGUgZXJyb3JzID0gaW5qZWN0KEVycm9yU2VydmljZSk7XG5cbiAgQFNlbGVjdG9yKClcbiAgc3RhdGljIHNpZGVuYXZPcGVuZWQoc3RhdGU6IENvcmVTdGF0ZU1vZGVsKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHN0YXRlPy5zaWRlbmF2T3BlbmVkO1xuICB9XG5cbiAgQFNlbGVjdG9yKClcbiAgc3RhdGljIHBlcm1pc3Npb25zKHN0YXRlOiBDb3JlU3RhdGVNb2RlbCk6IHN0cmluZ1tdIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gc3RhdGU/LmF1dGguc2Vzc2lvbkluZm8/LnBlcm1pc3Npb25zW0RvbWFpbi5HbG9iYWxdO1xuICB9XG5cbiAgQFNlbGVjdG9yKClcbiAgc3RhdGljIGhhc1Blcm1pc3Npb24oc3RhdGU6IENvcmVTdGF0ZU1vZGVsKTogKHBlcm1pc3Npb25zOiBzdHJpbmdbXSkgPT4gYm9vbGVhbiB7XG4gICAgcmV0dXJuIChwZXJtaXNzaW9uczogc3RyaW5nW10pOiBib29sZWFuID0+IHtcbiAgICAgIGlmIChzdGF0ZT8uYXV0aC5zZXNzaW9uSW5mbz8ucGVybWlzc2lvbnNbRG9tYWluLkdsb2JhbF0pIHtcbiAgICAgICAgcmV0dXJuIHN0YXRlLmF1dGguc2Vzc2lvbkluZm8ucGVybWlzc2lvbnNbRG9tYWluLkdsb2JhbF0uc29tZSgocDogc3RyaW5nKSA9PiBwZXJtaXNzaW9ucy5pbmNsdWRlcyhwKSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9O1xuICB9XG5cbiAgQFNlbGVjdG9yKClcbiAgc3RhdGljIGlzQXV0aGVudGljYXRlZChzdGF0ZTogQ29yZVN0YXRlTW9kZWwpOiBib29sZWFuIHtcbiAgICByZXR1cm4gc3RhdGU/LmF1dGguYXV0aGVudGljYXRlZDtcbiAgfVxuXG4gIEBTZWxlY3RvcigpXG4gIHN0YXRpYyByZWRpcmVjdFVybChzdGF0ZTogQ29yZVN0YXRlTW9kZWwpOiBzdHJpbmcge1xuICAgIHJldHVybiBzdGF0ZT8uYXV0aC5yZWRpcmVjdFVybDtcbiAgfVxuXG4gIEBTZWxlY3RvcigpXG4gIHN0YXRpYyBpc0xvYWRpbmcoc3RhdGU6IENvcmVTdGF0ZU1vZGVsKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHN0YXRlLmxvYWRpbmcubGVuZ3RoID4gMDtcbiAgfVxuXG4gIEBTZWxlY3RvcigpXG4gIHN0YXRpYyBjdXJyZW50U2lkZW5hdklkZW50aWZpZXIoc3RhdGU6IENvcmVTdGF0ZU1vZGVsKTogc3RyaW5nIHtcbiAgICByZXR1cm4gc3RhdGUuY3VycmVudFNpZGVuYXZJZGVudGlmaWVyO1xuICB9XG5cbiAgQEFjdGlvbihbQXBwQWN0aW9uLlNldE5hdklkZW50aWZpZXJdKVxuICBzZXROYXZJZGVudGlmaWVyKGN0eDogU3RhdGVDb250ZXh0PENvcmVTdGF0ZU1vZGVsPiwgYWN0aW9uOiBBcHBBY3Rpb24uU2V0TmF2SWRlbnRpZmllcik6IHZvaWQge1xuICAgIGN0eC5zZXRTdGF0ZShcbiAgICAgIHBhdGNoKHtcbiAgICAgICAgY3VycmVudFNpZGVuYXZJZGVudGlmaWVyOiBhY3Rpb24uaWRlbnRpZmllcixcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIEBBY3Rpb24oW0FwaUludGVyY2VwdG9yQWN0aW9uLlB1Ymxpc2hFcnJvciwgTG9naW5BY3Rpb24uUHVibGlzaEVycm9yXSlcbiAgcHVibGlzaEVycm9yKGN0eDogU3RhdGVDb250ZXh0PENvcmVTdGF0ZU1vZGVsPiwgYWN0aW9uOiB7IG1lc3NhZ2U6IEVycm9yTWVzc2FnZSB9KTogdm9pZCB7XG4gICAgdGhpcy5lcnJvcnMuYWRkR2xvYmFsRXJyb3IoYWN0aW9uLm1lc3NhZ2UpO1xuICB9XG5cbiAgQEFjdGlvbihbQXBwQWN0aW9uLkNoZWNrVXNlclNlc3Npb24sIEF1dGhlbnRpY2F0aW9uR3VhcmRBY3Rpb24uQ2hlY2tVc2VyU2Vzc2lvbl0pXG4gIGNoZWNrVXNlclNlc3Npb24oY3R4OiBTdGF0ZUNvbnRleHQ8Q29yZVN0YXRlTW9kZWw+KTogT2JzZXJ2YWJsZTxTZXNzaW9uSW5mbyB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5hdXRoU2VydmljZS5jaGVja1VzZXJTZXNzaW9uKCkucGlwZShcbiAgICAgIHRhcCgocmVzdWx0KSA9PlxuICAgICAgICBjdHguc2V0U3RhdGUoXG4gICAgICAgICAgcGF0Y2goe1xuICAgICAgICAgICAgYXV0aDogcGF0Y2goe1xuICAgICAgICAgICAgICBhdXRoZW50aWNhdGVkOiAhIXJlc3VsdD8uYXV0aGVudGljYXRlZCxcbiAgICAgICAgICAgICAgc2Vzc2lvbkluZm86IHJlc3VsdCxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgQEFjdGlvbihbTG9naW5BY3Rpb24uTG9nb3V0XSlcbiAgbG9nb3V0KGN0eDogU3RhdGVDb250ZXh0PENvcmVTdGF0ZU1vZGVsPik6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGxvY2FsU3RhdGVDb3B5ID0gY2xvbmVEZWVwKGluaXRTdGF0ZSk7XG4gICAgbG9jYWxTdGF0ZUNvcHkuYXV0aC5yZWRpcmVjdFVybCA9IGN0eC5nZXRTdGF0ZSgpLmF1dGgucmVkaXJlY3RVcmw7XG4gICAgcmV0dXJuIHRoaXMuYXV0aFNlcnZpY2UubG9nb3V0KCkucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIGN0eC5zZXRTdGF0ZShsb2NhbFN0YXRlQ29weSk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBAQWN0aW9uKFtcbiAgICBBcHBBY3Rpb24uU2V0UmVkaXJlY3RVcmwsXG4gICAgTG9naW5BY3Rpb24uU2V0UmVkaXJlY3RVcmwsXG4gICAgQXV0aGVudGljYXRpb25HdWFyZEFjdGlvbi5TZXRSZWRpcmVjdFVybCxcbiAgICBBcGlJbnRlcmNlcHRvckFjdGlvbi5TZXRSZWRpcmVjdFVybCxcbiAgXSlcbiAgc2V0UmVkaXJlY3RVcmwoY3R4OiBTdGF0ZUNvbnRleHQ8Q29yZVN0YXRlTW9kZWw+LCBhY3Rpb246IHsgcmVkaXJlY3RVcmw6IHN0cmluZyB9KTogQ29yZVN0YXRlTW9kZWwge1xuICAgIGN0eC5zZXRTdGF0ZShcbiAgICAgIHBhdGNoKHtcbiAgICAgICAgYXV0aDogcGF0Y2goe1xuICAgICAgICAgIHJlZGlyZWN0VXJsOiBhY3Rpb24ucmVkaXJlY3RVcmwsXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICApO1xuICAgIHJldHVybiBjdHguZ2V0U3RhdGUoKTtcbiAgfVxuXG4gIEBBY3Rpb24oW0FwaUludGVyY2VwdG9yQWN0aW9uLkJlZ2luQWN0aXZpdHldKVxuICBiZWdpbkFjdGl2aXR5KGN0eDogU3RhdGVDb250ZXh0PENvcmVTdGF0ZU1vZGVsPiwgYWN0aW9uOiB7IHByb2Nlc3M6IHN0cmluZyB9KTogQ29yZVN0YXRlTW9kZWwge1xuICAgIGNvbnN0IHN0YXRlID0gY3R4LmdldFN0YXRlKCk7XG4gICAgY3R4LnBhdGNoU3RhdGUoe1xuICAgICAgbG9hZGluZzogW2FjdGlvbi5wcm9jZXNzLCAuLi5zdGF0ZS5sb2FkaW5nXSxcbiAgICB9KTtcbiAgICByZXR1cm4gY3R4LmdldFN0YXRlKCk7XG4gIH1cblxuICBAQWN0aW9uKFtBcGlJbnRlcmNlcHRvckFjdGlvbi5FbmRBY3Rpdml0eV0pXG4gIGVuZEFjdGl2aXR5KGN0eDogU3RhdGVDb250ZXh0PENvcmVTdGF0ZU1vZGVsPiwgYWN0aW9uOiB7IHByb2Nlc3M6IHN0cmluZyB9KTogQ29yZVN0YXRlTW9kZWwgfCBudWxsIHtcbiAgICBjb25zdCBsb2FkaW5nID0gY3R4LmdldFN0YXRlKCkubG9hZGluZztcbiAgICAvLyBUaGVyZSBjYW4gYmUgbXVsdGlwbGUgYWN0aXZpdGllcyBydW5uaW5nIHdpdGggdGhlIHNhbWUgcHJvY2VzcyBzaWduYXR1cmVcbiAgICBjb25zdCBpbmRleCA9IGxvYWRpbmcuZmluZEluZGV4KChhY3Rpdml0eSkgPT4gYWN0aXZpdHkgPT09IGFjdGlvbi5wcm9jZXNzKTtcbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICBjb25zdCBuZXdMb2FkaW5nID0gWy4uLmxvYWRpbmcuc2xpY2UoMCwgaW5kZXgpLCAuLi5sb2FkaW5nLnNsaWNlKGluZGV4ICsgMSldO1xuICAgICAgY3R4LnBhdGNoU3RhdGUoe1xuICAgICAgICBsb2FkaW5nOiBuZXdMb2FkaW5nLFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gY3R4LmdldFN0YXRlKCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgQEFjdGlvbihbSGVhZGVyQWN0aW9uLlRvZ2dsZVNpZGVuYXZdKVxuICB0b2dnbGVTaWRlbmF2KGN0eDogU3RhdGVDb250ZXh0PENvcmVTdGF0ZU1vZGVsPik6IHZvaWQge1xuICAgIGN0eC5zZXRTdGF0ZShcbiAgICAgIHBhdGNoKHtcbiAgICAgICAgc2lkZW5hdk9wZW5lZDogIWN0eC5nZXRTdGF0ZSgpLnNpZGVuYXZPcGVuZWQsXG4gICAgICB9KVxuICAgICk7XG4gIH1cbn1cbiJdfQ==